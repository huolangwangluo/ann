<!DOCTYPE html>
<html style="background: url(https://example.com/anime-bg.gif) fixed">
<head>
    <title>å®˜æœºæŒ‰é’®ç”Ÿæˆå™¨</title>
    <!-- æ–°å¢å­—ä½“å’Œå›¾æ ‡åº“ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
    <style>
        /* æ–°å¢äºŒæ¬¡å…ƒé£æ ¼CSS */
        body {
            font-family: 'Comic Sans MS', cursive;
            background: linear-gradient(to right, #ffdde1, #ffa2b5);
        }
        
        .container {
            backdrop-filter: blur(5px);
            border-radius: 25px;
            padding: 2rem;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 30px rgba(255,105,180,0.3);
        }

        button {
            border-radius: 15px !important;
            background: linear-gradient(45deg, #ff79ad, #ffb3d9) !important;
            border: 2px solid white !important;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 0 5px pink);
        }

        h1 {
            color: #ff4d8a;
            text-shadow: 2px 2px 0 white;
            font-size: 2.5rem;
        }
        
        /* åŠ¨æ€å® ç‰©å…ƒç´  */
        .waifu-avatar {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 200px;
            transition: transform 0.5s;
        }
    </style>
</head>
<body>
    <!-- æ–°å¢åŠ¨æ€å® ç‰© -->
    <img src="https://example.com/floating-waifu.gif" class="waifu-avatar" alt="åŠ¨æ€åŠ©æ‰‹">

    <div class="container mt-5">
        <h1 class="text-center mb-4">âœ¨å®˜æœºæŒ‰é’®ç”Ÿæˆå™¨ğŸ€</h1>
        
        <!-- åŸæœ‰ç»“æ„æ”¹é€  -->
        <div class="main-workspace p-4 mb-4" style="border-radius:20px;border:3px dashed pink">
            <!-- åŸæœ‰åŠŸèƒ½æŒ‰é’®å¢åŠ å›¾æ ‡ -->
                 </div>

        <!-- ä¿ç•™åŸæœ‰JSåŠŸèƒ½ -->
        <script>
            // ä¿ç•™æ‰€æœ‰åŸå§‹JavaScriptåŠŸèƒ½ä»£ç 
            function addButtonRow() { /* åŸæœ‰å®ç° */ }
            function generateTemplate() { /* åŸæœ‰å®ç° */ }
        </script>
</body>
</html>
<style>
/* åŠ¨æ€èƒŒæ™¯å›¾å±‚ */
body::after {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('https://i.gifer.com/2yDp.gif') repeat;
    opacity: 0.15;
    z-index: -1;
}

button {
    border-radius: 35px!important;
    background: linear-gradient(145deg, #ff89de 0%, #8985ff 100%);
    box-shadow: 0 4px 20px rgba(255, 71, 195, 0.3);
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    position: relative;
    overflow: visible;
}

/* æŒ‰é’®æ‚¬æµ®åŠ¨æ€ */
button:hover {
    transform: translateY(-5px) rotate(-3deg);
    box-shadow: 0 8px 30px rgba(137, 133, 255, 0.5);
}

button::after {
    content: "â™ª";
    position: absolute;
    right: -20px;
    top: -15px;
    font-size: 24px;
    color: #ffec47;
    animation: bounce 1s infinite;
}

@keyframes sparkle {
    0% { opacity: 0; transform: scale(1); }
    100% { opacity: 1; transform: scale(2); }
}

/* åŠ¨æ€è§’è‰²è£…é¥° */
.chibi-char {
    position: fixed;
    width: 180px;
    transition: transform 0.3s;
    pointer-events: none;
    z-index: 999;
}

#char-left {
    left: -50px;
    bottom: -30px;
    animation: float 3s ease-in-out infinite;
}

#char-right {
    right: -50px;
    bottom: 0;
    animation: float 3s ease-in-out infinite 0.5s;
}

@keyframes float {
    0%, 100% { transform: translateY(0) rotate(-5deg); }
    50% { transform: translateY(-20px) rotate(5deg); }
}
</style>

<!-- åŠ¨æ€è£…é¥°ç»„ä»¶ -->
<img src="//i.imgur.com/ZMhSGOE.gif" class="chibi-char" id="char-left">
<img src="//i.imgur.com/Xixo9b8.gif" class="chibi-char" id="char-right">

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <style>
body {
  font-family : 'Microsoft YaHei', sans-serif;
  margin : 0;
  padding : 0;
  background-color : #F5F5F5;
  height : 100vh;
  overflow-x : hidden;
}

.container {
  max-width : 100%;
  width : 100%;
  margin : 0 auto;
  background-color : #FFFFFF;
  padding : 20px;
  border-radius : 0;
  box-shadow : 0 2px 10px rgba(0, 0, 0, .1);
  min-height : 100vh;
  box-sizing : border-box;
}

.page-title {
  text-align : center;
  margin-bottom : 30px;
  color : #333333;
}

.main-buttons {
  display : flex;
  gap : 10px;
  margin : 20px 0;
}

.main-buttons button {
  padding : 8px 16px;
  border-radius : 4px;
  cursor : pointer;
  background-color : #1890FF;
  color : white;
  border : none;
}

.main-buttons button:hover {
  background-color : #40A9FF;
}

.preview-container {
  margin : 20px 0;
}

.button-rows-container {
  display : flex;
  flex-direction : column;
  gap : 8px;
  border : 1px solid #E8E8E8;
  border-radius : 4px;
  padding : 12px;
  background-color : #FAFAFA;
}

.button-row-container {
  display : flex;
  align-items : center;
  gap : 8px;
  margin-bottom : 0;
}

.delete-row-button {
  width : 24px;
  height : 24px;
  border-radius : 50%;
  background-color : #F5F5F5;
  border : 1px solid #D9D9D9;
  color : #FF4D4F;
  display : flex;
  align-items : center;
  justify-content : center;
  cursor : pointer;
  font-size : 16px;
  line-height : 1;
  flex-shrink : 0;
}

.delete-row-button:hover {
  background-color : #FFF1F0;
  border-color : #FF4D4F;
}

.button-row-wrapper {
  flex : 1;
}

.button-row {
  display : flex;
  flex-wrap : wrap;
  gap : 8px;
  width : 100%;
}

.preview-button {
  padding : 8px 16px;
  border-radius : 4px;
  cursor : pointer;
  text-align : center;
  font-size : 14px;
  white-space : nowrap;
  overflow : hidden;
  text-overflow : ellipsis;
  flex : 1;
  min-width : 80px;
  box-sizing : border-box;
  user-select : none;
}

.preview-button.dragging {
  opacity : .5;
  border : 2px dashed #1890FF;
}

.preview-button.over {
  border : 2px dashed #40A9FF;
  background-color : rgba(24, 144, 255, .1);
}

.add-button {
  padding : 8px 16px;
  border-radius : 4px;
  cursor : pointer;
  text-align : center;
  font-size : 14px;
  background-color : #F0F0F0;
  color : #666666;
  border : 1px dashed #D9D9D9;
}

.add-button:hover {
  border-color : #40A9FF;
  color : #40A9FF;
}

.style-0 {
  border : 1px solid #D9D9D9;
  background-color : #FFFFFF;
  color : #333333;
}

.style-1 {
  border : 1px solid #1890FF;
  background-color : #FFFFFF;
  color : #1890FF;
}

.style-3 {
  border : 1px solid #FF4D4F;
  background-color : #FFFFFF;
  color : #FF4D4F;
}

.style-4 {
  border : none;
  background-color : #1890FF;
  color : #FFFFFF;
}

.output-section {
  margin-top : 30px;
  padding : 15px;
  border : 1px solid #E8E8E8;
  border-radius : 4px;
}

.output-header {
  display : flex;
  justify-content : space-between;
  align-items : center;
  margin-bottom : 15px;
}

#output {
  background-color : #F5F5F5;
  padding : 15px;
  border-radius : 4px;
  max-height : 300px;
  overflow-y : auto;
  white-space : pre-wrap;
}

.edit-dialog {
  position : fixed;
  top : 0;
  left : 0;
  width : 100%;
  height : 100%;
  background-color : rgba(0, 0, 0, .5);
  display : flex;
  justify-content : center;
  align-items : center;
  z-index : 1000;
}

.dialog-content {
  background-color : white;
  padding : 20px;
  border-radius : 8px;
  width : 400px;
  max-width : 90%;
  max-height : 90vh;
  overflow-y : auto;
}

.form-group {
  margin-bottom : 15px;
}

.form-group label {
  display : block;
  margin-bottom : 5px;
  font-weight : bold;
}

.form-group input, .form-group select {
  width : 100%;
  padding : 8px;
  border : 1px solid #D9D9D9;
  border-radius : 4px;
  box-sizing : border-box;
}

.dialog-buttons {
  display : flex;
  justify-content : flex-end;
  gap : 10px;
  margin-top : 20px;
}

.dialog-buttons button {
  padding : 8px 16px;
  border-radius : 4px;
  cursor : pointer;
}

#cancel-button {
  background-color : #F5F5F5;
  border : 1px solid #D9D9D9;
}

#save-button {
  background-color : #1890FF;
  color : white;
  border : none;
}

.action-button {
  padding : 8px 16px;
  border-radius : 4px;
  cursor : pointer;
  background-color : #1890FF;
  color : white;
  border : none;
}

.action-button:hover {
  background-color : #40A9FF;
}

h2 {
  margin-bottom : 10px;
  display : flex;
  align-items : center;
  flex-wrap : wrap;
}

h2 button.action-button {
  margin-left : 10px;
  padding : 5px 12px;
  border-radius : 4px;
  cursor : pointer;
  background-color : #1890FF;
  color : white;
  border : none;
  font-size : 14px;
  line-height : 1.5;
  font-weight : normal;
}

h2 button.action-button:hover {
  background-color : #40A9FF;
}



    </style>
</head>

<body>
    <div class="container">


        <div class="workspaces-container" style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <div class="preview-container">
                    <h2>
                        ä¸»å·¥ä½œå°
                        <button onclick="addRow()" class="action-button">æ·»åŠ æŒ‰é’®è¡Œ</button>
                        <button onclick="generate()" class="action-button">ç”Ÿæˆæ¨¡æ¿</button>
                        <button onclick="importTemplate()" class="action-button">å¯¼å…¥æ¨¡æ¿</button>
                    </h2>
                    <div id="buttonRows" class="button-rows-container"></div>
                </div>
            </div>
            
            <div style="flex: 1;">
                <div class="preview-container">
                    <h2>
                        å‰¯å·¥ä½œå°
                        <button onclick="importSecondaryTemplate()" class="action-button">å¯¼å…¥æ¨¡æ¿</button>
                    </h2>
                    <div id="secondaryButtonRows" class="button-rows-container" style="background-color: #f0f8ff;"></div>
                </div>
            </div>
        </div>

        <div class="output-section">
            <div class="output-header">
                <h2>ç”Ÿæˆç»“æœ</h2>
                <button id="copyButton" class="action-button" onclick="copyTemplate()">å¤åˆ¶æ¨¡æ¿</button>
            </div>
            <pre id="output"></pre>
        </div>
    </div>

    <script>
        let rowCount = 0;
        let buttonConfigs = {};
        let secondaryRowCount = 0;
        let secondaryButtonConfigs = {};

        // æ·»åŠ æŒ‰é’®è¡Œ
        function addRow() {
            if (rowCount >= 5) {
                alert('æœ€å¤šæ”¯æŒ5è¡ŒæŒ‰é’®');
                return;
            }

            const rowId = 'row-' + Date.now();
            const row = document.createElement('div');
            row.className = 'button-row-container';
            row.id = rowId;

            row.innerHTML = `
                <button class="delete-row-button" onclick="deleteRow(this)" title="åˆ é™¤æ­¤è¡Œ">Ã—</button>
                <div class="button-row-wrapper">
                    <div class="button-row">
                        <div class="add-button" onclick="addButtonToRow('${rowId}')">+ æ·»åŠ æŒ‰é’®</div>
                    </div>
                </div>
            `;

            document.getElementById('buttonRows').appendChild(row);
            rowCount++;

            // åˆå§‹åŒ–æ­¤è¡Œçš„æŒ‰é’®é…ç½®å­˜å‚¨
            buttonConfigs[rowId] = [];
        }

        // åˆ é™¤è¡Œ
        function deleteRow(button) {
            const row = button.closest('.button-row-container');
            const rowId = row.id;

            // åˆ é™¤è¡Œé…ç½®
            delete buttonConfigs[rowId];

            // åˆ é™¤è¡Œå…ƒç´ 
            row.remove();

            // æ›´æ–°è¡Œè®¡æ•°
            rowCount--;
        }

        // å‘æŒ‡å®šè¡Œæ·»åŠ æŒ‰é’®
        function addButtonToRow(rowId) {
            const row = document.getElementById(rowId);
            const buttonRow = row.querySelector('.button-row');
            const addButton = buttonRow.querySelector('.add-button');

            // æ£€æŸ¥æŒ‰é’®æ•°é‡
            const buttons = buttonRow.querySelectorAll('.preview-button');
            if (buttons.length >= 5) {
                alert('æ¯è¡Œæœ€å¤šæ”¯æŒ5ä¸ªæŒ‰é’®');
                return;
            }

            // åˆ›å»ºæ–°æŒ‰é’®é…ç½®
            const buttonIndex = buttonConfigs[rowId].length;
            const buttonConfig = {
                id: buttonIndex + 1,
                label: 'æŒ‰é’®æ–‡å­—',
                visited_label: 'æŒ‰é’®æ–‡å­—',
                type: 2, // é»˜è®¤ä¸ºæŒ‡ä»¤ç±»å‹
                style: 0,
                permission: 2,
                data: '',
                click_limit: 10,
                unsupport_tips: 'æŒ‰é’®æ–‡å­—',
                at_bot_show_channel_list: true,
                enter: true
            };

            // å­˜å‚¨æŒ‰é’®é…ç½®
            buttonConfigs[rowId].push(buttonConfig);

            // åˆ›å»ºé¢„è§ˆæŒ‰é’®
            const previewButton = document.createElement('div');
            previewButton.className = 'preview-button style-0';
            previewButton.textContent = 'æŒ‰é’®æ–‡å­—';
            previewButton.setAttribute('data-index', buttonIndex);
            previewButton.onclick = function (e) {
                // å¦‚æœæ˜¯æ‹–åŠ¨ç»“æŸï¼Œä¸æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
                if (e.target.getAttribute('data-dragging') === 'true') {
                    e.target.removeAttribute('data-dragging');
                    return;
                }
                openEditDialog(rowId, buttonIndex);
            };

            // æ·»åŠ æ‹–æ”¾åŠŸèƒ½
            previewButton.draggable = true;
            previewButton.addEventListener('dragstart', handleDragStart);
            previewButton.addEventListener('dragover', handleDragOver);
            previewButton.addEventListener('dragenter', handleDragEnter);
            previewButton.addEventListener('dragleave', handleDragLeave);
            previewButton.addEventListener('drop', handleDrop);
            previewButton.addEventListener('dragend', handleDragEnd);

            // æ’å…¥åˆ°æ·»åŠ æŒ‰é’®ä¹‹å‰
            buttonRow.insertBefore(previewButton, addButton);

            // æ›´æ–°æŒ‰é’®å®½åº¦
            updateButtonWidths(rowId);
        }

        // æ‹–æ”¾ç›¸å…³å˜é‡
        let dragSrcEl = null;
        let dragSrcRowId = null;

        // æ‹–åŠ¨å¼€å§‹
        function handleDragStart(e) {
            this.classList.add('dragging');

            dragSrcEl = this;
            dragSrcRowId = this.closest('.button-row-container').id;

            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);

            // æ ‡è®°ä¸ºæ­£åœ¨æ‹–åŠ¨
            this.setAttribute('data-dragging', 'true');
        }

        // æ‹–åŠ¨ç»è¿‡
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        // æ‹–åŠ¨è¿›å…¥
        function handleDragEnter(e) {
            this.classList.add('over');
        }

        // æ‹–åŠ¨ç¦»å¼€
        function handleDragLeave(e) {
            this.classList.remove('over');
        }

        // æ”¾ç½®
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();

            // å¦‚æœæ‹–æ”¾åˆ°è‡ªå·±ä¸Šé¢ï¼Œä¸åšä»»ä½•æ“ä½œ
            if (dragSrcEl === this) {
                return false;
            }

            const targetRowId = this.closest('.button-row-container').id;
            const srcIndex = parseInt(dragSrcEl.getAttribute('data-index'));
            const targetIndex = parseInt(this.getAttribute('data-index'));

            // æ£€æŸ¥ç´¢å¼•æ˜¯å¦æœ‰æ•ˆ
            if (isNaN(srcIndex) || isNaN(targetIndex) ||
                !buttonConfigs[dragSrcRowId] || !buttonConfigs[targetRowId] ||
                srcIndex < 0 || srcIndex >= buttonConfigs[dragSrcRowId].length ||
                targetIndex < 0 || targetIndex >= buttonConfigs[targetRowId].length) {
                console.error('æ— æ•ˆçš„æ‹–æ”¾ç´¢å¼•:', dragSrcRowId, srcIndex, '->', targetRowId, targetIndex);
                return false;
            }

            console.log('æ‹–æ”¾æ“ä½œ:', dragSrcRowId, srcIndex, '->', targetRowId, targetIndex);

            // åŒä¸€è¡Œå†…çš„æŒ‰é’®äº¤æ¢
            if (dragSrcRowId === targetRowId) {
                // äº¤æ¢é…ç½®
                const temp = { ...buttonConfigs[targetRowId][srcIndex] };
                buttonConfigs[targetRowId][srcIndex] = { ...buttonConfigs[targetRowId][targetIndex] };
                buttonConfigs[targetRowId][targetIndex] = temp;

                // æ›´æ–°è¡Œé¢„è§ˆ
                updateRowPreview(targetRowId);
            }
            // ä¸åŒè¡Œä¹‹é—´çš„æŒ‰é’®äº¤æ¢
            else {
                // æ£€æŸ¥ç›®æ ‡è¡ŒæŒ‰é’®æ•°é‡
                if (buttonConfigs[targetRowId].length >= 5) {
                    alert('ç›®æ ‡è¡Œå·²è¾¾åˆ°æœ€å¤§æŒ‰é’®æ•°é‡(5ä¸ª)');
                    return false;
                }

                // ä¿å­˜ä¸¤ä¸ªæŒ‰é’®çš„é…ç½®å‰¯æœ¬
                const srcButtonConfig = { ...buttonConfigs[dragSrcRowId][srcIndex] };
                const targetButtonConfig = { ...buttonConfigs[targetRowId][targetIndex] };

                // å§‹ç»ˆä¿ç•™æºæŒ‰é’®çš„å‰¯æœ¬ï¼Œå³ä½¿æ˜¯å”¯ä¸€çš„æŒ‰é’®
                buttonConfigs[targetRowId][targetIndex] = srcButtonConfig;
                buttonConfigs[dragSrcRowId][srcIndex] = targetButtonConfig;

                // æ›´æ–°ä¸¤è¡Œçš„é¢„è§ˆ
                updateRowPreview(dragSrcRowId);
                updateRowPreview(targetRowId);

                // æ›´æ–°æŒ‰é’®ID
                updateButtonIds(dragSrcRowId);
                updateButtonIds(targetRowId);
            }

            return false;
        }

        // æ‹–åŠ¨ç»“æŸ
        function handleDragEnd(e) {
            // ç§»é™¤æ‰€æœ‰æ‹–åŠ¨ç›¸å…³çš„ç±»
            document.querySelectorAll('.preview-button').forEach(button => {
                button.classList.remove('dragging');
                button.classList.remove('over');
            });

            // æ¸…é™¤æ‹–åŠ¨æ ‡è®°å’Œæ‹–åŠ¨æº
            setTimeout(() => {
                if (this) {
                    this.removeAttribute('data-dragging');
                }
                dragSrcEl = null;
                dragSrcRowId = null;
            }, 100);
        }

        // æ›´æ–°æŒ‰é’®å®½åº¦å’Œæ–‡æœ¬æ˜¾ç¤º
        function updateButtonWidths(rowId) {
            const row = document.getElementById(rowId);
            const buttonRow = row.querySelector('.button-row');
            const buttons = buttonRow.querySelectorAll('.preview-button');

            // è®¡ç®—æ¯ä¸ªæŒ‰é’®çš„æœ€å¤§å­—ç¬¦æ•°
            const totalButtons = buttons.length;
            const maxCharsMap = {
                1: 12, // ä¸€ä¸ªæŒ‰é’®æœ€å¤š12ä¸ªå­—
                2: 6,  // ä¸¤ä¸ªæŒ‰é’®æœ€å¤š6ä¸ªå­—
                3: 4,  // ä¸‰ä¸ªæŒ‰é’®æœ€å¤š4ä¸ªå­—
                4: 3,  // å››ä¸ªæŒ‰é’®æœ€å¤š3ä¸ªå­—
                5: 2   // äº”ä¸ªæŒ‰é’®æœ€å¤š2ä¸ªå­—
            };
            const maxChars = maxCharsMap[totalButtons] || 2;

            // æ›´æ–°æ¯ä¸ªæŒ‰é’®çš„æ–‡æœ¬æ˜¾ç¤º
            buttons.forEach((button, index) => {
                const config = buttonConfigs[rowId][index];
                if (config) {
                    const originalText = config.label || 'æŒ‰é’®æ–‡å­—';
                    button.title = originalText; // æ·»åŠ å®Œæ•´æ–‡æœ¬ä½œä¸ºæç¤º

                    // å¦‚æœæ–‡æœ¬è¶…è¿‡æœ€å¤§å­—ç¬¦æ•°ï¼Œåˆ™æˆªæ–­å¹¶æ·»åŠ çœç•¥å·
                    if (originalText.length > maxChars) {
                        button.textContent = originalText.substring(0, maxChars) + '...';
                    } else {
                        button.textContent = originalText;
                    }
                }
            });
        }

        // æ›´æ–°æŒ‰é’®ID
        function updateButtonIds(rowId) {
            const row = document.getElementById(rowId);
            const buttons = row.querySelectorAll('.preview-button');

            buttons.forEach((button, index) => {
                button.setAttribute('data-index', index);
                if (buttonConfigs[rowId][index]) {
                    buttonConfigs[rowId][index].id = index + 1;
                }
            });

            // æ›´æ–°æŒ‰é’®å®½åº¦
            updateButtonWidths(rowId);
        }

        // æ‰“å¼€ç¼–è¾‘å¼¹çª—
        function openEditDialog(rowId, buttonIndex) {
            const config = buttonConfigs[rowId][buttonIndex];
            if (!config) return;

            // åˆ›å»ºå¼¹çª—
            const dialog = document.createElement('div');
            dialog.className = 'edit-dialog';

            // å¼¹çª—å†…å®¹
            dialog.innerHTML = `
                <div class="dialog-content" style="width: 600px; max-width: 90%;">
                    <h3>ç¼–è¾‘æŒ‰é’®</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                        <div class="form-group" style="flex: 0 0 20%;">
                            <label>æŒ‰é’®ID:</label>
                            <input type="number" id="edit-id" value="${config.id}" readonly>
                        </div>
                        <div class="form-group" style="flex: 0 0 35%;">
                            <label>æŒ‰é’®æ–‡å­—:</label>
                            <input type="text" id="edit-label" value="${config.label}">
                        </div>
                        <div class="form-group" style="flex: 0 0 35%;">
                            <label>ç‚¹å‡»åæ–‡å­—:</label>
                            <input type="text" id="edit-visited-label" value="${config.visited_label || config.label}">
                        </div>
                        <div class="form-group" style="flex: 0 0 30%;">
                            <label>æŒ‰é’®ç±»å‹:</label>
                            <select id="edit-type">
                                <option value="0" ${config.type === 0 ? 'selected' : ''}>è·³è½¬</option>
                                <option value="1" ${config.type === 1 ? 'selected' : ''}>å›è°ƒ</option>
                                <option value="2" ${config.type === 2 ? 'selected' : ''}>æŒ‡ä»¤</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 0 0 65%;" id="edit-options">
                            ${config.type === 0 ? `
                                <label>è·³è½¬é“¾æ¥:</label>
                                <input type="url" id="edit-url" placeholder="http://" value="${config.data || ''}">
                            ` : config.type === 1 ? `
                                <label>å›è°ƒæ•°æ®:</label>
                                <div style="display: flex; gap: 10px;">
                                    <div style="flex: 1;">
                                        <label style="font-size: 12px;">ç‚¹å‡»:</label>
                                        <input type="text" id="edit-callback-click" placeholder="ç‚¹å‡»å›è°ƒ" value="${typeof config.data === 'object' ? config.data.click || '' : config.data || ''
                    }">
                                    </div>
                                    <div style="flex: 1;">
                                        <label style="font-size: 12px;">ç¡®è®¤:</label>
                                        <input type="text" id="edit-callback-confirm" placeholder="ç¡®è®¤å›è°ƒ" value="${typeof config.data === 'object' ? config.data.confirm || '' : ''
                    }">
                                    </div>
                                    <div style="flex: 1;">
                                        <label style="font-size: 12px;">å–æ¶ˆ:</label>
                                        <input type="text" id="edit-callback-cancel" placeholder="å–æ¶ˆå›è°ƒ" value="${typeof config.data === 'object' ? config.data.cancel || '' : ''
                    }">
                                    </div>
                                </div>
                            ` : `
                                <label>æŒ‡ä»¤å†…å®¹:</label>
                                <input type="text" id="edit-command" placeholder="æŒ‡ä»¤å†…å®¹ (é»˜è®¤ä¸æŒ‰é’®æ–‡å­—ä¸€è‡´)" value="${config.data || ''}">
                            `}
                        </div>
                        <div class="form-group" style="flex: 0 0 30%;">
                            <label>æŒ‰é’®æ ·å¼:</label>
                            <select id="edit-style">
                                <option value="0" ${config.style === 0 ? 'selected' : ''}>ç°è‰²çº¿æ¡†</option>
                                <option value="1" ${config.style === 1 ? 'selected' : ''}>è“è‰²çº¿æ¡†</option>
                                <option value="3" ${config.style === 3 ? 'selected' : ''}>çº¢è‰²æ–‡å­—</option>
                                <option value="4" ${config.style === 4 ? 'selected' : ''}>è“è‰²èƒŒæ™¯</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 0 0 30%;">
                            <label>æƒé™ç±»å‹:</label>
                            <select id="edit-permission">
                                <option value="0" ${config.permission === 0 ? 'selected' : ''}>æŒ‡å®šç”¨æˆ·</option>
                                <option value="1" ${config.permission === 1 ? 'selected' : ''}>ä»…ç®¡ç†å‘˜</option>
                                <option value="2" ${config.permission === 2 ? 'selected' : ''}>æ‰€æœ‰äºº</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 0 0 30%;">
                            <label>ç‚¹å‡»æ¬¡æ•°é™åˆ¶:</label>
                            <input type="number" id="edit-click-limit" value="${config.click_limit || 10}" min="0">
                        </div>
                        <div class="form-group" style="flex: 0 0 100%;">
                            <label>ä¸æ”¯æŒæç¤º:</label>
                            <input type="text" id="edit-unsupport-tips" value="${config.unsupport_tips || config.label}">
                        </div>
                        <div class="form-group" style="flex: 0 0 45%; display: flex; align-items: center;">
                            <input type="checkbox" id="edit-at-bot" ${config.at_bot_show_channel_list ? 'checked' : ''} style="margin-right: 8px; width: auto;">
                            <label for="edit-at-bot" style="margin-bottom: 0;">æ˜¾ç¤ºé¢‘é“åˆ—è¡¨</label>
                        </div>
                        <div class="form-group" style="flex: 0 0 45%; display: flex; align-items: center;">
                            <input type="checkbox" id="edit-enter" ${config.enter ? 'checked' : ''} style="margin-right: 8px; width: auto;">
                            <label for="edit-enter" style="margin-bottom: 0;">è‡ªåŠ¨å‘é€</label>
                        </div>
                    </div>
                    <div class="dialog-buttons" style="display: flex; justify-content: space-between; margin-top: 20px;">
                        <div>
                            <button onclick="deleteButton('${rowId}', ${buttonIndex})" style="background-color: #ff4d4f; color: white; border: none;">åˆ é™¤æŒ‰é’®</button>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="cancel-button">å–æ¶ˆ</button>
                            <button id="save-button">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;

            // æ·»åŠ å¼¹çª—åˆ°é¡µé¢
            document.body.appendChild(dialog);


            // ç±»å‹å˜æ›´äº‹ä»¶
            document.getElementById('edit-type').addEventListener('change', function () {
                const type = parseInt(this.value);
                const optionsDiv = document.getElementById('edit-options');

                if (type === 0) {
                    optionsDiv.innerHTML = `
            <label>è·³è½¬é“¾æ¥:</label>
            <input type="url" id="edit-url" placeholder="http://" value="${config.data || ''}">
        `;
                } else if (type === 1) {
                    optionsDiv.innerHTML = `
            <label>å›è°ƒæ•°æ®:</label>
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label style="font-size: 12px;">ç‚¹å‡»:</label>
                    <input type="text" id="edit-callback-click" placeholder="ç‚¹å‡»å›è°ƒ" value="${typeof config.data === 'object' ? config.data.click || '' : config.data || ''
                        }">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 12px;">ç¡®è®¤:</label>
                    <input type="text" id="edit-callback-confirm" placeholder="ç¡®è®¤å›è°ƒ" value="${typeof config.data === 'object' ? config.data.confirm || '' : ''
                        }">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 12px;">å–æ¶ˆ:</label>
                    <input type="text" id="edit-callback-cancel" placeholder="å–æ¶ˆå›è°ƒ" value="${typeof config.data === 'object' ? config.data.cancel || '' : ''
                        }">
                </div>
            </div>
        `;
                } else {
                    optionsDiv.innerHTML = `
            <label>æŒ‡ä»¤å†…å®¹:</label>
            <input type="text" id="edit-command" placeholder="æŒ‡ä»¤å†…å®¹ (é»˜è®¤ä¸æŒ‰é’®æ–‡å­—ä¸€è‡´)" value="${config.data || ''}">
        `;
                }
            });

            // ä¿å­˜æŒ‰é’®äº‹ä»¶
            document.getElementById('save-button').addEventListener('click', function () {
                const type = parseInt(document.getElementById('edit-type').value);

                config.label = document.getElementById('edit-label').value || 'æŒ‰é’®æ–‡å­—';
                config.visited_label = document.getElementById('edit-visited-label').value || config.label;
                config.type = type;
                config.style = parseInt(document.getElementById('edit-style').value);
                config.permission = parseInt(document.getElementById('edit-permission').value);
                config.click_limit = parseInt(document.getElementById('edit-click-limit').value) || 10;
                config.unsupport_tips = document.getElementById('edit-unsupport-tips').value || config.label;
                config.at_bot_show_channel_list = document.getElementById('edit-at-bot').checked;
                config.enter = document.getElementById('edit-enter').checked;

                if (type === 0) {
                    config.data = document.getElementById('edit-url').value || '';
                } else if (type === 1) {
                    config.data = {
                        click: document.getElementById('edit-callback-click').value || '',
                        confirm: document.getElementById('edit-callback-confirm').value || '',
                        cancel: document.getElementById('edit-callback-cancel').value || ''
                    };
                } else {
                    config.data = document.getElementById('edit-command').value || '';
                }

                // æ›´æ–°é¢„è§ˆ
                updateRowPreview(rowId);

                // å…³é—­å¼¹çª—
                dialog.remove();
            });

            // å–æ¶ˆæŒ‰é’®äº‹ä»¶
            document.getElementById('cancel-button').addEventListener('click', function () {
                dialog.remove();
            });
        }

        // æ›´æ–°è¡Œé¢„è§ˆ - ä¼˜åŒ–ç‰ˆæœ¬
        function updateRowPreview(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;

            const buttonRow = row.querySelector('.button-row');
            if (!buttonRow) return;

            const addButton = buttonRow.querySelector('.add-button');
            if (!addButton) return;

            // æ¸…é™¤ç°æœ‰æŒ‰é’®
            buttonRow.querySelectorAll('.preview-button').forEach(btn => btn.remove());

            // æ£€æŸ¥æŒ‰é’®é…ç½®æ˜¯å¦å­˜åœ¨
            if (!buttonConfigs[rowId] || !Array.isArray(buttonConfigs[rowId])) {
                console.error('æŒ‰é’®é…ç½®ä¸å­˜åœ¨:', rowId);
                buttonConfigs[rowId] = [];
                return;
            }

            // é‡æ–°åˆ›å»ºæŒ‰é’®
            buttonConfigs[rowId].forEach((config, index) => {
                if (!config) {
                    console.error('æŒ‰é’®é…ç½®ä¸ºç©º:', rowId, index);
                    return;
                }

                const previewButton = document.createElement('div');
                previewButton.className = `preview-button style-${config.style || 0}`;
                previewButton.textContent = config.label || 'æŒ‰é’®æ–‡å­—';
                previewButton.setAttribute('data-index', index);
                previewButton.onclick = function (e) {
                    if (e.target.getAttribute('data-dragging') === 'true') {
                        e.target.removeAttribute('data-dragging');
                        return;
                    }
                    openEditDialog(rowId, index);
                };

                // æ·»åŠ æ‹–æ”¾åŠŸèƒ½
                previewButton.draggable = true;
                previewButton.addEventListener('dragstart', handleDragStart);
                previewButton.addEventListener('dragover', handleDragOver);
                previewButton.addEventListener('dragenter', handleDragEnter);
                previewButton.addEventListener('dragleave', handleDragLeave);
                previewButton.addEventListener('drop', handleDrop);
                previewButton.addEventListener('dragend', handleDragEnd);

                // æ’å…¥åˆ°æ·»åŠ æŒ‰é’®ä¹‹å‰
                buttonRow.insertBefore(previewButton, addButton);
            });

            // æ›´æ–°æŒ‰é’®å®½åº¦
            updateButtonWidths(rowId);
        }

        // åˆ é™¤æŒ‰é’®
        function deleteButton(rowId, buttonIndex) {
            const row = document.getElementById(rowId);
            if (!row) return;

            // ç§»é™¤æŒ‰é’®é…ç½®
            buttonConfigs[rowId].splice(buttonIndex, 1);

            // ç§»é™¤é¢„è§ˆæŒ‰é’®
            const buttonRow = row.querySelector('.button-row');
            const buttons = buttonRow.querySelectorAll('.preview-button');
            if (buttons[buttonIndex]) {
                buttons[buttonIndex].remove();
            }

            // æ›´æ–°æŒ‰é’®ID
            updateButtonIds(rowId);

            // å…³é—­å¼¹çª—
            document.querySelector('.edit-dialog')?.remove();
        }

        // ç”Ÿæˆæ¨¡æ¿
        function generate() {
            if (rowCount === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€è¡ŒæŒ‰é’®');
                return;
            }

            const template = {
                rows: []
            };

            let buttonIdCounter = 1;

            document.querySelectorAll('.button-row-container').forEach(row => {
                const rowId = row.id;

                if (!buttonConfigs[rowId] || buttonConfigs[rowId].length === 0) {
                    return;
                }

                const rowData = {
                    buttons: []
                };

                buttonConfigs[rowId].forEach(config => {
                    const button = {
                        id: buttonIdCounter.toString(),
                        render_data: {
                            label: config.label,
                            visited_label: config.visited_label || config.label
                        },
                        action: {
                            type: config.type,
                            permission: {
                                type: config.permission,
                                specify_role_ids: ["1", "2", "3"]
                            },
                            click_limit: config.click_limit || 10,
                            unsupport_tips: config.unsupport_tips || config.label,
                            data: config.data || (config.type === 2 ? `/${config.label}` : ''),
                            at_bot_show_channel_list: config.at_bot_show_channel_list !== undefined ? config.at_bot_show_channel_list : true,
                            enter: config.enter !== undefined ? config.enter : true
                        }
                    };

                    rowData.buttons.push(button);
                    buttonIdCounter++;
                });

                template.rows.push(rowData);
            });

            document.getElementById('output').textContent = JSON.stringify(template, null, 2);
        }

        // å¤åˆ¶æ¨¡æ¿
        function copyTemplate() {
            const output = document.getElementById('output').textContent;
            if (!output) {
                alert('è¯·å…ˆç”Ÿæˆæ¨¡æ¿');
                return;
            }

            navigator.clipboard.writeText(output)
                .then(() => alert('æ¨¡æ¿å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))
                .catch(err => alert('å¤åˆ¶å¤±è´¥: ' + err));
        }

        // å¯¼å…¥æ¨¡æ¿
        function importTemplate() {
            // åˆ›å»ºå¼¹çª—
            const dialog = document.createElement('div');
            dialog.className = 'edit-dialog';

            // å¼¹çª—å†…å®¹
            dialog.innerHTML = `
                <div class="dialog-content">
                    <h3>å¯¼å…¥æŒ‰é’®æ¨¡æ¿</h3>
                    <div class="form-group">
                        <label>è¯·ç²˜è´´JSONæ¨¡æ¿:</label>
                        <textarea id="import-json" rows="10" style="width: 100%; padding: 8px; border: 1px solid #D9D9D9; border-radius: 4px; box-sizing: border-box;"></textarea>
                    </div>
                    <div class="dialog-buttons">
                        <button id="cancel-import">å–æ¶ˆ</button>
                        <button id="confirm-import">å¯¼å…¥</button>
                    </div>
                </div>
            `;

            // æ·»åŠ å¼¹çª—åˆ°é¡µé¢
            document.body.appendChild(dialog);

            // å–æ¶ˆæŒ‰é’®äº‹ä»¶
            document.getElementById('cancel-import').addEventListener('click', function () {
                dialog.remove();
            });

            // ç¡®è®¤å¯¼å…¥æŒ‰é’®äº‹ä»¶
            document.getElementById('confirm-import').addEventListener('click', function () {
                const jsonText = document.getElementById('import-json').value;
                if (!jsonText) {
                    alert('è¯·è¾“å…¥JSONæ¨¡æ¿');
                    return;
                }

                try {
                    const template = JSON.parse(jsonText);

                    // æ¸…ç©ºç°æœ‰æŒ‰é’®
                    document.getElementById('buttonRows').innerHTML = '';
                    buttonConfigs = {};
                    rowCount = 0;

                    // å¯¼å…¥æ¨¡æ¿
                    if (template.rows && Array.isArray(template.rows)) {
                        template.rows.forEach(row => {
                            if (row.buttons && Array.isArray(row.buttons)) {
                                // åˆ›å»ºæ–°è¡Œ
                                const rowId = 'row-' + Date.now() + Math.floor(Math.random() * 1000);
                                const rowElement = document.createElement('div');
                                rowElement.className = 'button-row-container';
                                rowElement.id = rowId;

                                rowElement.innerHTML = `
                                    <button class="delete-row-button" onclick="deleteRow(this)" title="åˆ é™¤æ­¤è¡Œ">Ã—</button>
                                    <div class="button-row-wrapper">
                                        <div class="button-row">
                                            <div class="add-button" onclick="addButtonToRow('${rowId}')">+ æ·»åŠ æŒ‰é’®</div>
                                        </div>
                                    </div>
                                `;

                                document.getElementById('buttonRows').appendChild(rowElement);
                                rowCount++;

                                // åˆå§‹åŒ–æ­¤è¡Œçš„æŒ‰é’®é…ç½®å­˜å‚¨
                                buttonConfigs[rowId] = [];

                                // æ·»åŠ æŒ‰é’®
                                row.buttons.forEach(button => {
                                    // å°è¯•ä»JSONä¸­æ¨æ–­æ ·å¼
                                    // å¯ä»¥é€šè¿‡æ ‡ç­¾æˆ–å…¶ä»–å±æ€§åˆ¤æ–­æ ·å¼
                                    let inferredStyle = 0; // é»˜è®¤æ ·å¼
                                    
                                    // æ ¹æ®æ ‡ç­¾åˆ¤æ–­æ ·å¼
                                    const label = button.render_data?.label || '';
                                    if (button.render_data?.style !== undefined) {
                                        // å¦‚æœæ¨¡æ¿ä¸­æ˜ç¡®åŒ…å«æ ·å¼ä¿¡æ¯
                                        inferredStyle = parseInt(button.render_data.style);
                                    } else {
                                        // æ ¹æ®å…¶ä»–å±æ€§æ¨æ–­æ ·å¼
                                        const actionType = button.action?.type;
                                        if (actionType === 0) { // è·³è½¬ç±»å‹é€šå¸¸ä½¿ç”¨è“è‰²çº¿æ¡†
                                            inferredStyle = 1;
                                        } else if (actionType === 1) { // å›è°ƒç±»å‹
                                            inferredStyle = 4; // è“è‰²èƒŒæ™¯
                                        }
                                        // å¦‚æœæ ‡ç­¾ä¸­åŒ…å«æŸäº›å…³é”®è¯ï¼Œå¯èƒ½æ˜¯è­¦å‘Š/å±é™©æŒ‰é’®
                                        if (label.includes('åˆ é™¤') || label.includes('å–æ¶ˆ') || 
                                            label.includes('é€€å‡º') || label.includes('å…³é—­')) {
                                            inferredStyle = 3; // çº¢è‰²æ–‡å­—
                                        }
                                    }

                                    const buttonConfig = {
                                        id: parseInt(button.id) || buttonConfigs[rowId].length + 1,
                                        label: button.render_data?.label || 'æŒ‰é’®æ–‡å­—',
                                        visited_label: button.render_data?.visited_label || button.render_data?.label || 'æŒ‰é’®æ–‡å­—',
                                        type: button.action?.type !== undefined ? parseInt(button.action.type) : 2,
                                        style: inferredStyle, // ä½¿ç”¨æ¨æ–­çš„æ ·å¼è€Œä¸æ˜¯ç¡¬ç¼–ç ä¸º0
                                        permission: button.action?.permission?.type !== undefined ? parseInt(button.action.permission.type) : 2,
                                        data: button.action?.type === 1 ?
                                            (typeof button.action.data === 'object' ?
                                                button.action.data :
                                                { click: button.action?.data || '', confirm: '', cancel: '' }) :
                                            button.action?.data || '',
                                        click_limit: button.action?.click_limit || 10,
                                        unsupport_tips: button.action?.unsupport_tips || button.render_data?.label || 'æŒ‰é’®æ–‡å­—',
                                        at_bot_show_channel_list: button.action?.at_bot_show_channel_list !== undefined ? button.action.at_bot_show_channel_list : true,
                                        enter: button.action?.enter !== undefined ? button.action.enter : true
                                    };

                                    // å­˜å‚¨æŒ‰é’®é…ç½®
                                    buttonConfigs[rowId].push(buttonConfig);
                                });

                                // æ›´æ–°è¡Œé¢„è§ˆ
                                updateRowPreview(rowId);
                            }
                        });
                    }

                    // å…³é—­å¼¹çª—
                    dialog.remove();

                    // ç”Ÿæˆé¢„è§ˆ
                    generate();

                } catch (error) {
                    alert('JSONæ ¼å¼é”™è¯¯: ' + error.message);
                }
            });
        }

        // æ·»åŠ è¡Œåˆ°å‰¯å·¥ä½œå°
        function addSecondaryRow() {
            if (secondaryRowCount >= 5) {
                alert('å‰¯å·¥ä½œå°æœ€å¤šæ”¯æŒ5è¡ŒæŒ‰é’®');
                return;
            }

            const rowId = 'secondary-row-' + Date.now();
            const row = document.createElement('div');
            row.className = 'button-row-container';
            row.id = rowId;

            row.innerHTML = `
                <button class="delete-row-button" onclick="deleteSecondaryRow(this)" title="åˆ é™¤æ­¤è¡Œ">Ã—</button>
                <div class="button-row-wrapper">
                    <div class="button-row">
                        <div class="add-button" onclick="addButtonToSecondaryRow('${rowId}')">+ æ·»åŠ æŒ‰é’®</div>
                    </div>
                </div>
            `;

            document.getElementById('secondaryButtonRows').appendChild(row);
            secondaryRowCount++;

            // åˆå§‹åŒ–æ­¤è¡Œçš„æŒ‰é’®é…ç½®å­˜å‚¨
            secondaryButtonConfigs[rowId] = [];
        }
        
        // åˆ é™¤å‰¯å·¥ä½œå°çš„è¡Œ
        function deleteSecondaryRow(button) {
            const row = button.closest('.button-row-container');
            const rowId = row.id;

            // åˆ é™¤è¡Œé…ç½®
            delete secondaryButtonConfigs[rowId];

            // åˆ é™¤è¡Œå…ƒç´ 
            row.remove();

            // æ›´æ–°è¡Œè®¡æ•°
            secondaryRowCount--;
        }
        
        // å‘å‰¯å·¥ä½œå°çš„æŒ‡å®šè¡Œæ·»åŠ æŒ‰é’®
        function addButtonToSecondaryRow(rowId) {
            const row = document.getElementById(rowId);
            const buttonRow = row.querySelector('.button-row');
            const addButton = buttonRow.querySelector('.add-button');

            // æ£€æŸ¥æŒ‰é’®æ•°é‡
            const buttons = buttonRow.querySelectorAll('.preview-button');
            if (buttons.length >= 5) {
                alert('æ¯è¡Œæœ€å¤šæ”¯æŒ5ä¸ªæŒ‰é’®');
                return;
            }

            // åˆ›å»ºæ–°æŒ‰é’®é…ç½®
            const buttonIndex = secondaryButtonConfigs[rowId].length;
            const buttonConfig = {
                id: buttonIndex + 1,
                label: 'æŒ‰é’®æ–‡å­—',
                visited_label: 'æŒ‰é’®æ–‡å­—',
                type: 2,
                style: 0,
                permission: 2,
                data: '',
                click_limit: 10,
                unsupport_tips: 'æŒ‰é’®æ–‡å­—',
                at_bot_show_channel_list: true,
                enter: true
            };

            // å­˜å‚¨æŒ‰é’®é…ç½®
            secondaryButtonConfigs[rowId].push(buttonConfig);

            // åˆ›å»ºé¢„è§ˆæŒ‰é’®
            const previewButton = document.createElement('div');
            previewButton.className = 'preview-button style-0';
            previewButton.textContent = 'æŒ‰é’®æ–‡å­—';
            previewButton.setAttribute('data-index', buttonIndex);
            previewButton.setAttribute('data-secondary', 'true');
            previewButton.onclick = function (e) {
                // å¦‚æœæ˜¯æ‹–åŠ¨ç»“æŸï¼Œä¸æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
                if (e.target.getAttribute('data-dragging') === 'true') {
                    e.target.removeAttribute('data-dragging');
                    return;
                }
                openSecondaryEditDialog(rowId, buttonIndex);
            };

            // æ·»åŠ æ‹–æ”¾åŠŸèƒ½
            previewButton.draggable = true;
            previewButton.addEventListener('dragstart', handleDragStart);
            previewButton.addEventListener('dragover', handleDragOver);
            previewButton.addEventListener('dragenter', handleDragEnter);
            previewButton.addEventListener('dragleave', handleDragLeave);
            previewButton.addEventListener('drop', handleDrop);
            previewButton.addEventListener('dragend', handleDragEnd);

            // æ’å…¥åˆ°æ·»åŠ æŒ‰é’®ä¹‹å‰
            buttonRow.insertBefore(previewButton, addButton);

            // æ›´æ–°æŒ‰é’®å®½åº¦
            updateSecondaryButtonWidths(rowId);
        }
        
        // æ›´æ–°å‰¯å·¥ä½œå°æŒ‰é’®å®½åº¦å’Œæ–‡æœ¬æ˜¾ç¤º
        function updateSecondaryButtonWidths(rowId) {
            const row = document.getElementById(rowId);
            const buttonRow = row.querySelector('.button-row');
            const buttons = buttonRow.querySelectorAll('.preview-button');

            // è®¡ç®—æ¯ä¸ªæŒ‰é’®çš„æœ€å¤§å­—ç¬¦æ•°
            const totalButtons = buttons.length;
            const maxCharsMap = {
                1: 12,
                2: 6,
                3: 4,
                4: 3,
                5: 2
            };
            const maxChars = maxCharsMap[totalButtons] || 2;

            // æ›´æ–°æ¯ä¸ªæŒ‰é’®çš„æ–‡æœ¬æ˜¾ç¤º
            buttons.forEach((button, index) => {
                const config = secondaryButtonConfigs[rowId][index];
                if (config) {
                    const originalText = config.label || 'æŒ‰é’®æ–‡å­—';
                    button.title = originalText;

                    if (originalText.length > maxChars) {
                        button.textContent = originalText.substring(0, maxChars) + '...';
                    } else {
                        button.textContent = originalText;
                    }
                }
            });
        }
        
        // æ›´æ–°å‰¯å·¥ä½œå°æŒ‰é’®ID
        function updateSecondaryButtonIds(rowId) {
            const row = document.getElementById(rowId);
            const buttons = row.querySelectorAll('.preview-button');

            buttons.forEach((button, index) => {
                button.setAttribute('data-index', index);
                if (secondaryButtonConfigs[rowId][index]) {
                    secondaryButtonConfigs[rowId][index].id = index + 1;
                }
            });

            updateSecondaryButtonWidths(rowId);
        }
        
        // æ‰“å¼€å‰¯å·¥ä½œå°ç¼–è¾‘å¼¹çª—
        function openSecondaryEditDialog(rowId, buttonIndex) {
            const config = secondaryButtonConfigs[rowId][buttonIndex];
            if (!config) return;
            
            // å¼¹çª—å†…å®¹å’Œé€»è¾‘ä¸ä¸»å·¥ä½œå°ç›¸åŒï¼Œåªéœ€æ›¿æ¢ç›¸å…³å˜é‡
            // åˆ›å»ºå¼¹çª—
            const dialog = document.createElement('div');
            dialog.className = 'edit-dialog';

            // å¼¹çª—å†…å®¹
            dialog.innerHTML = `
                <div class="dialog-content" style="width: 600px; max-width: 90%;">
                    <h3>ç¼–è¾‘æŒ‰é’®</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                        <div class="form-group" style="flex: 0 0 20%;">
                            <label>æŒ‰é’®ID:</label>
                            <input type="number" id="edit-id" value="${config.id}" readonly>
                        </div>
                        <div class="form-group" style="flex: 0 0 35%;">
                            <label>æŒ‰é’®æ–‡å­—:</label>
                            <input type="text" id="edit-label" value="${config.label}">
                        </div>
                        <div class="form-group" style="flex: 0 0 35%;">
                            <label>ç‚¹å‡»åæ–‡å­—:</label>
                            <input type="text" id="edit-visited-label" value="${config.visited_label || config.label}">
                        </div>
                        <div class="form-group" style="flex: 0 0 30%;">
                            <label>æŒ‰é’®ç±»å‹:</label>
                            <select id="edit-type">
                                <option value="0" ${config.type === 0 ? 'selected' : ''}>è·³è½¬</option>
                                <option value="1" ${config.type === 1 ? 'selected' : ''}>å›è°ƒ</option>
                                <option value="2" ${config.type === 2 ? 'selected' : ''}>æŒ‡ä»¤</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 0 0 65%;" id="edit-options">
                            ${config.type === 0 ? `
                                <label>è·³è½¬é“¾æ¥:</label>
                                <input type="url" id="edit-url" placeholder="http://" value="${config.data || ''}">
                            ` : config.type === 1 ? `
                                <label>å›è°ƒæ•°æ®:</label>
                                <div style="display: flex; gap: 10px;">
                                    <div style="flex: 1;">
                                        <label style="font-size: 12px;">ç‚¹å‡»:</label>
                                        <input type="text" id="edit-callback-click" placeholder="ç‚¹å‡»å›è°ƒ" value="${typeof config.data === 'object' ? config.data.click || '' : config.data || ''}">
                                    </div>
                                    <div style="flex: 1;">
                                        <label style="font-size: 12px;">ç¡®è®¤:</label>
                                        <input type="text" id="edit-callback-confirm" placeholder="ç¡®è®¤å›è°ƒ" value="${typeof config.data === 'object' ? config.data.confirm || '' : ''}">
                                    </div>
                                    <div style="flex: 1;">
                                        <label style="font-size: 12px;">å–æ¶ˆ:</label>
                                        <input type="text" id="edit-callback-cancel" placeholder="å–æ¶ˆå›è°ƒ" value="${typeof config.data === 'object' ? config.data.cancel || '' : ''}">
                                    </div>
                                </div>
                            ` : `
                                <label>æŒ‡ä»¤å†…å®¹:</label>
                                <input type="text" id="edit-command" placeholder="æŒ‡ä»¤å†…å®¹ (é»˜è®¤ä¸æŒ‰é’®æ–‡å­—ä¸€è‡´)" value="${config.data || ''}">
                            `}
                        </div>
                        <div class="form-group" style="flex: 0 0 30%;">
                            <label>æŒ‰é’®æ ·å¼:</label>
                            <select id="edit-style">
                                <option value="0" ${config.style === 0 ? 'selected' : ''}>ç°è‰²çº¿æ¡†</option>
                                <option value="1" ${config.style === 1 ? 'selected' : ''}>è“è‰²çº¿æ¡†</option>
                                <option value="3" ${config.style === 3 ? 'selected' : ''}>çº¢è‰²æ–‡å­—</option>
                                <option value="4" ${config.style === 4 ? 'selected' : ''}>è“è‰²èƒŒæ™¯</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 0 0 30%;">
                            <label>æƒé™ç±»å‹:</label>
                            <select id="edit-permission">
                                <option value="0" ${config.permission === 0 ? 'selected' : ''}>æŒ‡å®šç”¨æˆ·</option>
                                <option value="1" ${config.permission === 1 ? 'selected' : ''}>ä»…ç®¡ç†å‘˜</option>
                                <option value="2" ${config.permission === 2 ? 'selected' : ''}>æ‰€æœ‰äºº</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 0 0 30%;">
                            <label>ç‚¹å‡»æ¬¡æ•°é™åˆ¶:</label>
                            <input type="number" id="edit-click-limit" value="${config.click_limit || 10}" min="0">
                        </div>
                        <div class="form-group" style="flex: 0 0 100%;">
                            <label>ä¸æ”¯æŒæç¤º:</label>
                            <input type="text" id="edit-unsupport-tips" value="${config.unsupport_tips || config.label}">
                        </div>
                        <div class="form-group" style="flex: 0 0 45%; display: flex; align-items: center;">
                            <input type="checkbox" id="edit-at-bot" ${config.at_bot_show_channel_list ? 'checked' : ''} style="margin-right: 8px; width: auto;">
                            <label for="edit-at-bot" style="margin-bottom: 0;">æ˜¾ç¤ºé¢‘é“åˆ—è¡¨</label>
                        </div>
                        <div class="form-group" style="flex: 0 0 45%; display: flex; align-items: center;">
                            <input type="checkbox" id="edit-enter" ${config.enter ? 'checked' : ''} style="margin-right: 8px; width: auto;">
                            <label for="edit-enter" style="margin-bottom: 0;">è‡ªåŠ¨å‘é€</label>
                        </div>
                    </div>
                    <div class="dialog-buttons" style="display: flex; justify-content: space-between; margin-top: 20px;">
                        <div>
                            <button onclick="deleteSecondaryButton('${rowId}', ${buttonIndex})" style="background-color: #ff4d4f; color: white; border: none;">åˆ é™¤æŒ‰é’®</button>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="cancel-button">å–æ¶ˆ</button>
                            <button id="save-button">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;

            // æ·»åŠ å¼¹çª—åˆ°é¡µé¢
            document.body.appendChild(dialog);

            // ç±»å‹å˜æ›´äº‹ä»¶
            document.getElementById('edit-type').addEventListener('change', function () {
                const type = parseInt(this.value);
                const optionsDiv = document.getElementById('edit-options');

                if (type === 0) {
                    optionsDiv.innerHTML = `
                        <label>è·³è½¬é“¾æ¥:</label>
                        <input type="url" id="edit-url" placeholder="http://" value="${config.data || ''}">
                    `;
                } else if (type === 1) {
                    optionsDiv.innerHTML = `
                        <label>å›è°ƒæ•°æ®:</label>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label style="font-size: 12px;">ç‚¹å‡»:</label>
                                <input type="text" id="edit-callback-click" placeholder="ç‚¹å‡»å›è°ƒ" value="${typeof config.data === 'object' ? config.data.click || '' : config.data || ''}">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 12px;">ç¡®è®¤:</label>
                                <input type="text" id="edit-callback-confirm" placeholder="ç¡®è®¤å›è°ƒ" value="${typeof config.data === 'object' ? config.data.confirm || '' : ''}">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 12px;">å–æ¶ˆ:</label>
                                <input type="text" id="edit-callback-cancel" placeholder="å–æ¶ˆå›è°ƒ" value="${typeof config.data === 'object' ? config.data.cancel || '' : ''}">
                            </div>
                        </div>
                    `;
                } else {
                    optionsDiv.innerHTML = `
                        <label>æŒ‡ä»¤å†…å®¹:</label>
                        <input type="text" id="edit-command" placeholder="æŒ‡ä»¤å†…å®¹ (é»˜è®¤ä¸æŒ‰é’®æ–‡å­—ä¸€è‡´)" value="${config.data || ''}">
                    `;
                }
            });

            // ä¿å­˜æŒ‰é’®äº‹ä»¶
            document.getElementById('save-button').addEventListener('click', function () {
                const type = parseInt(document.getElementById('edit-type').value);

                config.label = document.getElementById('edit-label').value || 'æŒ‰é’®æ–‡å­—';
                config.visited_label = document.getElementById('edit-visited-label').value || config.label;
                config.type = type;
                config.style = parseInt(document.getElementById('edit-style').value);
                config.permission = parseInt(document.getElementById('edit-permission').value);
                config.click_limit = parseInt(document.getElementById('edit-click-limit').value) || 10;
                config.unsupport_tips = document.getElementById('edit-unsupport-tips').value || config.label;
                config.at_bot_show_channel_list = document.getElementById('edit-at-bot').checked;
                config.enter = document.getElementById('edit-enter').checked;

                if (type === 0) {
                    config.data = document.getElementById('edit-url').value || '';
                } else if (type === 1) {
                    config.data = {
                        click: document.getElementById('edit-callback-click').value || '',
                        confirm: document.getElementById('edit-callback-confirm').value || '',
                        cancel: document.getElementById('edit-callback-cancel').value || ''
                    };
                } else {
                    config.data = document.getElementById('edit-command').value || '';
                }

                // æ›´æ–°é¢„è§ˆ
                updateSecondaryRowPreview(rowId);

                // å…³é—­å¼¹çª—
                dialog.remove();
            });

            // å–æ¶ˆæŒ‰é’®äº‹ä»¶
            document.getElementById('cancel-button').addEventListener('click', function () {
                dialog.remove();
            });
        }
        
        // åˆ é™¤å‰¯å·¥ä½œå°æŒ‰é’®
        function deleteSecondaryButton(rowId, buttonIndex) {
            const row = document.getElementById(rowId);
            if (!row) return;

            // ç§»é™¤æŒ‰é’®é…ç½®
            secondaryButtonConfigs[rowId].splice(buttonIndex, 1);

            // ç§»é™¤é¢„è§ˆæŒ‰é’®
            const buttonRow = row.querySelector('.button-row');
            const buttons = buttonRow.querySelectorAll('.preview-button');
            if (buttons[buttonIndex]) {
                buttons[buttonIndex].remove();
            }

            // æ›´æ–°æŒ‰é’®ID
            updateSecondaryButtonIds(rowId);

            // å…³é—­å¼¹çª—
            document.querySelector('.edit-dialog')?.remove();
        }
        
        // æ›´æ–°å‰¯å·¥ä½œå°è¡Œé¢„è§ˆ
        function updateSecondaryRowPreview(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;

            const buttonRow = row.querySelector('.button-row');
            if (!buttonRow) return;

            const addButton = buttonRow.querySelector('.add-button');
            if (!addButton) return;

            // æ¸…é™¤ç°æœ‰æŒ‰é’®
            buttonRow.querySelectorAll('.preview-button').forEach(btn => btn.remove());

            // æ£€æŸ¥æŒ‰é’®é…ç½®æ˜¯å¦å­˜åœ¨
            if (!secondaryButtonConfigs[rowId] || !Array.isArray(secondaryButtonConfigs[rowId])) {
                console.error('å‰¯å·¥ä½œå°æŒ‰é’®é…ç½®ä¸å­˜åœ¨:', rowId);
                secondaryButtonConfigs[rowId] = [];
                return;
            }

            // é‡æ–°åˆ›å»ºæŒ‰é’®
            secondaryButtonConfigs[rowId].forEach((config, index) => {
                if (!config) {
                    console.error('å‰¯å·¥ä½œå°æŒ‰é’®é…ç½®ä¸ºç©º:', rowId, index);
                    return;
                }

                const previewButton = document.createElement('div');
                previewButton.className = `preview-button style-${config.style || 0}`;
                previewButton.textContent = config.label || 'æŒ‰é’®æ–‡å­—';
                previewButton.setAttribute('data-index', index);
                previewButton.setAttribute('data-secondary', 'true');
                previewButton.onclick = function (e) {
                    if (e.target.getAttribute('data-dragging') === 'true') {
                        e.target.removeAttribute('data-dragging');
                        return;
                    }
                    openSecondaryEditDialog(rowId, index);
                };

                // æ·»åŠ æ‹–æ”¾åŠŸèƒ½
                previewButton.draggable = true;
                previewButton.addEventListener('dragstart', handleDragStart);
                previewButton.addEventListener('dragover', handleDragOver);
                previewButton.addEventListener('dragenter', handleDragEnter);
                previewButton.addEventListener('dragleave', handleDragLeave);
                previewButton.addEventListener('drop', handleDrop);
                previewButton.addEventListener('dragend', handleDragEnd);

                // æ’å…¥åˆ°æ·»åŠ æŒ‰é’®ä¹‹å‰
                buttonRow.insertBefore(previewButton, addButton);
            });

            // æ›´æ–°æŒ‰é’®å®½åº¦
            updateSecondaryButtonWidths(rowId);
        }
        
        // å¯¼å…¥æ¨¡æ¿åˆ°å‰¯å·¥ä½œå°
        function importSecondaryTemplate() {
            // åˆ›å»ºå¼¹çª—
            const dialog = document.createElement('div');
            dialog.className = 'edit-dialog';

            // å¼¹çª—å†…å®¹
            dialog.innerHTML = `
                <div class="dialog-content">
                    <h3>å¯¼å…¥æŒ‰é’®æ¨¡æ¿åˆ°å‰¯å·¥ä½œå°</h3>
                    <div class="form-group">
                        <label>è¯·ç²˜è´´JSONæ¨¡æ¿:</label>
                        <textarea id="import-json" rows="10" style="width: 100%; padding: 8px; border: 1px solid #D9D9D9; border-radius: 4px; box-sizing: border-box;"></textarea>
                    </div>
                    <div class="dialog-buttons">
                        <button id="cancel-import">å–æ¶ˆ</button>
                        <button id="confirm-import">å¯¼å…¥</button>
                    </div>
                </div>
            `;

            // æ·»åŠ å¼¹çª—åˆ°é¡µé¢
            document.body.appendChild(dialog);

            // å–æ¶ˆæŒ‰é’®äº‹ä»¶
            document.getElementById('cancel-import').addEventListener('click', function () {
                dialog.remove();
            });

            // ç¡®è®¤å¯¼å…¥æŒ‰é’®äº‹ä»¶
            document.getElementById('confirm-import').addEventListener('click', function () {
                const jsonText = document.getElementById('import-json').value;
                if (!jsonText) {
                    alert('è¯·è¾“å…¥JSONæ¨¡æ¿');
                    return;
                }

                try {
                    const template = JSON.parse(jsonText);

                    // æ¸…ç©ºå‰¯å·¥ä½œå°ç°æœ‰æŒ‰é’®
                    document.getElementById('secondaryButtonRows').innerHTML = '';
                    secondaryButtonConfigs = {};
                    secondaryRowCount = 0;

                    // å¯¼å…¥æ¨¡æ¿åˆ°å‰¯å·¥ä½œå°
                    if (template.rows && Array.isArray(template.rows)) {
                        template.rows.forEach(row => {
                            if (row.buttons && Array.isArray(row.buttons)) {
                                // åˆ›å»ºæ–°è¡Œ
                                const rowId = 'secondary-row-' + Date.now() + Math.floor(Math.random() * 1000);
                                const rowElement = document.createElement('div');
                                rowElement.className = 'button-row-container';
                                rowElement.id = rowId;

                                rowElement.innerHTML = `
                                    <button class="delete-row-button" onclick="deleteSecondaryRow(this)" title="åˆ é™¤æ­¤è¡Œ">Ã—</button>
                                    <div class="button-row-wrapper">
                                        <div class="button-row">
                                            <div class="add-button" onclick="addButtonToSecondaryRow('${rowId}')">+ æ·»åŠ æŒ‰é’®</div>
                                        </div>
                                    </div>
                                `;

                                document.getElementById('secondaryButtonRows').appendChild(rowElement);
                                secondaryRowCount++;

                                // åˆå§‹åŒ–æ­¤è¡Œçš„æŒ‰é’®é…ç½®å­˜å‚¨
                                secondaryButtonConfigs[rowId] = [];

                                // æ·»åŠ æŒ‰é’®
                                row.buttons.forEach(button => {
                                    // å°è¯•ä»JSONä¸­æ¨æ–­æ ·å¼
                                    let inferredStyle = 0;
                                    
                                    // æ ¹æ®æ ‡ç­¾åˆ¤æ–­æ ·å¼
                                    const label = button.render_data?.label || '';
                                    if (button.render_data?.style !== undefined) {
                                        inferredStyle = parseInt(button.render_data.style);
                                    } else {
                                        const actionType = button.action?.type;
                                        if (actionType === 0) {
                                            inferredStyle = 1;
                                        } else if (actionType === 1) {
                                            inferredStyle = 4;
                                        }
                                        if (label.includes('åˆ é™¤') || label.includes('å–æ¶ˆ') || 
                                            label.includes('é€€å‡º') || label.includes('å…³é—­')) {
                                            inferredStyle = 3;
                                        }
                                    }

                                    const buttonConfig = {
                                        id: parseInt(button.id) || secondaryButtonConfigs[rowId].length + 1,
                                        label: button.render_data?.label || 'æŒ‰é’®æ–‡å­—',
                                        visited_label: button.render_data?.visited_label || button.render_data?.label || 'æŒ‰é’®æ–‡å­—',
                                        type: button.action?.type !== undefined ? parseInt(button.action.type) : 2,
                                        style: inferredStyle,
                                        permission: button.action?.permission?.type !== undefined ? parseInt(button.action.permission.type) : 2,
                                        data: button.action?.type === 1 ?
                                            (typeof button.action.data === 'object' ?
                                                button.action.data :
                                                { click: button.action?.data || '', confirm: '', cancel: '' }) :
                                            button.action?.data || '',
                                        click_limit: button.action?.click_limit || 10,
                                        unsupport_tips: button.action?.unsupport_tips || button.render_data?.label || 'æŒ‰é’®æ–‡å­—',
                                        at_bot_show_channel_list: button.action?.at_bot_show_channel_list !== undefined ? button.action.at_bot_show_channel_list : true,
                                        enter: button.action?.enter !== undefined ? button.action.enter : true
                                    };

                                    // å­˜å‚¨æŒ‰é’®é…ç½®
                                    secondaryButtonConfigs[rowId].push(buttonConfig);
                                });

                                // æ›´æ–°è¡Œé¢„è§ˆ
                                updateSecondaryRowPreview(rowId);
                            }
                        });
                    }

                    // å…³é—­å¼¹çª—
                    dialog.remove();

                } catch (error) {
                    alert('JSONæ ¼å¼é”™è¯¯: ' + error.message);
                }
            });
        }
        
        // ä¿®æ”¹æ‹–æ”¾å¤„ç†å‡½æ•°æ”¯æŒè·¨å·¥ä½œå°æ‹–æ”¾
        // æ‹–åŠ¨å¼€å§‹
        function handleDragStart(e) {
            this.classList.add('dragging');

            dragSrcEl = this;
            dragSrcRowId = this.closest('.button-row-container').id;
            dragSrcIsSecondary = this.hasAttribute('data-secondary');

            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            e.dataTransfer.setData('application/json', JSON.stringify({
                rowId: dragSrcRowId,
                isSecondary: dragSrcIsSecondary,
                index: this.getAttribute('data-index')
            }));

            // æ ‡è®°ä¸ºæ­£åœ¨æ‹–åŠ¨
            this.setAttribute('data-dragging', 'true');
        }
        
        // æ”¾ç½®å¤„ç†
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();

            // å¦‚æœæ‹–æ”¾åˆ°è‡ªå·±ä¸Šé¢ï¼Œä¸åšä»»ä½•æ“ä½œ
            if (dragSrcEl === this) {
                return false;
            }

            const targetRowId = this.closest('.button-row-container').id;
            const targetIsSecondary = this.hasAttribute('data-secondary');
            const srcIndex = parseInt(dragSrcEl.getAttribute('data-index'));
            const targetIndex = parseInt(this.getAttribute('data-index'));
            
            // è·å–æºæŒ‰é’®å’Œç›®æ ‡æŒ‰é’®çš„é…ç½®é›†åˆ
            const srcConfigs = dragSrcIsSecondary ? secondaryButtonConfigs : buttonConfigs;
            const targetConfigs = targetIsSecondary ? secondaryButtonConfigs : buttonConfigs;

            // æ£€æŸ¥ç´¢å¼•æ˜¯å¦æœ‰æ•ˆ
            if (isNaN(srcIndex) || isNaN(targetIndex) ||
                !srcConfigs[dragSrcRowId] || !targetConfigs[targetRowId] ||
                srcIndex < 0 || srcIndex >= srcConfigs[dragSrcRowId].length ||
                targetIndex < 0 || targetIndex >= targetConfigs[targetRowId].length) {
                console.error('æ— æ•ˆçš„æ‹–æ”¾ç´¢å¼•:', dragSrcRowId, srcIndex, '->', targetRowId, targetIndex);
                return false;
            }

            console.log('æ‹–æ”¾æ“ä½œ:', 
                (dragSrcIsSecondary ? 'å‰¯' : 'ä¸»') + dragSrcRowId, srcIndex, 
                '->',
                (targetIsSecondary ? 'å‰¯' : 'ä¸»') + targetRowId, targetIndex);

            // åŒä¸€å·¥ä½œå°åŒä¸€è¡Œå†…çš„æŒ‰é’®äº¤æ¢
            if (dragSrcRowId === targetRowId && dragSrcIsSecondary === targetIsSecondary) {
                // äº¤æ¢é…ç½®
                const temp = { ...srcConfigs[targetRowId][srcIndex] };
                srcConfigs[targetRowId][srcIndex] = { ...targetConfigs[targetRowId][targetIndex] };
                targetConfigs[targetRowId][targetIndex] = temp;

                // æ›´æ–°è¡Œé¢„è§ˆ
                if (targetIsSecondary) {
                    updateSecondaryRowPreview(targetRowId);
                } else {
                    updateRowPreview(targetRowId);
                }
            }
            // ä¸åŒè¡Œæˆ–ä¸åŒå·¥ä½œå°ä¹‹é—´çš„æŒ‰é’®äº¤æ¢
            else {
                // æ£€æŸ¥ç›®æ ‡è¡ŒæŒ‰é’®æ•°é‡
                if (targetConfigs[targetRowId].length >= 5) {
                    alert('ç›®æ ‡è¡Œå·²è¾¾åˆ°æœ€å¤§æŒ‰é’®æ•°é‡(5ä¸ª)');
                    return false;
                }

                // ä¿å­˜ä¸¤ä¸ªæŒ‰é’®çš„é…ç½®å‰¯æœ¬
                const srcButtonConfig = { ...srcConfigs[dragSrcRowId][srcIndex] };
                const targetButtonConfig = { ...targetConfigs[targetRowId][targetIndex] };

                // äº¤æ¢æŒ‰é’®é…ç½®
                targetConfigs[targetRowId][targetIndex] = srcButtonConfig;
                srcConfigs[dragSrcRowId][srcIndex] = targetButtonConfig;

                // æ›´æ–°ä¸¤è¡Œçš„é¢„è§ˆ
                if (dragSrcIsSecondary) {
                    updateSecondaryRowPreview(dragSrcRowId);
                } else {
                    updateRowPreview(dragSrcRowId);
                }
                
                if (targetIsSecondary) {
                    updateSecondaryRowPreview(targetRowId);
                } else {
                    updateRowPreview(targetRowId);
                }

                // æ›´æ–°æŒ‰é’®ID
                if (dragSrcIsSecondary) {
                    updateSecondaryButtonIds(dragSrcRowId);
                } else {
                    updateButtonIds(dragSrcRowId);
                }
                
                if (targetIsSecondary) {
                    updateSecondaryButtonIds(targetRowId);
                } else {
                    updateButtonIds(targetRowId);
                }
            }

            return false;
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            // åˆå§‹æ·»åŠ ä¸€è¡ŒæŒ‰é’®åˆ°ä¸»å·¥ä½œå°
            addRow();
            
            // åˆå§‹æ·»åŠ ä¸€è¡ŒæŒ‰é’®åˆ°å‰¯å·¥ä½œå°
            addSecondaryRow();
        });
    </script>
</body>

</html>